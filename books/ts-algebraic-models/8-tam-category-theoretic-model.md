---
title: "圏論による模型"
cssclass: zenn
date: 2024-02-10
modified: 2024-02-10
AutoNoteMover: disable
tags: type/zenn/book, TypeTheory/Subtyping, TypeScript/type, math/algebra
aliases: TAM本『圏論による模型』
---

## 圏と圏論

「圏論 (category theory)」とは「対象 (object)」の集まりとそれらの間の関係を表す「射 (morphism あるいは arrow)」の集まりからなる構造である「圏 (category)」を研究する学問分野です。

考えているものが以下の「圏の公理」さえ満たせばそれは圏と言えるので、様々なものが圏という構造であるとみなせます (あるいは圏を構築できます)。

- 結合律 $h \circ (g \circ f) = (h \circ g) \circ f$
- 単位律 $1 \circ f = f$

圏論の概念は特に [Haskell](https://www.haskell.org) という言語で利用されていますが、Haskell 以外でも圏論は使えますし、実はオブジェクト指向言語の部分型関係においても一部の概念 (変性) は圏論由来のものです。圏論は上で述べたように圏の公理さえ満たせば圏としてみなせるので、TypeScript が持つような型システムについても圏を考えることができます。

## 部分型関係(前順序関係)の圏

ここで考える圏は、Haskell における対象が型で射が関数の圏である [Hask](https://ja.wikibooks.org/wiki/Haskell/%E5%9C%8F%E8%AB%96) とは異なるものであることに注意してください。

ここでは「**対象を型、射を部分型関係とする圏**」を考えます。部分型関係は少なくとも前順序 (pre-order) でしたので、型と前順序関係の圏と置き換えてもいいでしょう。

// 前順序の圏の図

任意の前順序集合は台集合 $P$ の要素を圏の対象とし、要素間の前順序関係 $<$ を射とした圏を構成します。基本的に圏の対象間の射は一つとはかぎりませんが、前順序の圏では対象と対象の間の射はあってもただ一つとなります。もちろん前順序では要素間が比較不能である場合(関係がない場合)もあるので、そのような二対象間では射が無いということになります。

恒等射は前順序関係の反射律($A < A$)による自分自身との関係が相当し、射の合成は推移律($A < B \land B < C \Rightarrow A < C$)によって保証されて、圏の公理を満たします。

さて、今までの議論は前順序関係を部分型関係に置き換えても成り立つわけですから、ここからはそのまま「部分型関係の圏」を考えていきます。

## 変性と自己関手

圏論の概念を導入することでやっかいな変性(variance)の概念をかなりスッキリと理解できるようになります。

変性は圏論由来の概念であり、具体的には変性の種類である共変性(covariance)や反変性(contravariance)は圏の関手(functor)という概念から来ています。

関手とは、圏から別の圏への対応付け(mapping)であり、ある圏内の対象と射をそれぞれ別の圏内の対象と射へと写すというものです。

このとき、圏の構造(恒等射と射の合成や向き)をそのまま保ったまま別の圏へつ写す関手は共変関手(covariant functor)と呼ばれます。逆に、射の方向(合成)を逆転させるような関手は反変関手(contravariant functor)と呼ばれます。

自己関手(endofunctor)とは、特殊な関手であり、圏から同じ圏へと対応付けするような関手のことです。もっともわかりやすい自己関手は恒等関手(identity functor)であり、圏の恒等射と同じように、自分自身についてなにも特別なことをしないでそのまま写します。つまり、それぞれの対象と射をそのまま同じ対象と射に写します。

自己関手はもちろん恒等関手だけでなく、様々なものが存在し、共変であったり反変であったりします。

さて、型と部分型関係の圏において、自己関手に相当するものはどのようなものが考えられるでしょうか？勘の良い人は変性の概念からなんとなく気づくかもしれませんが、型構築子が自己関手に相当します。

型構築子(type constructor)とは、型から新しい型を構築するものであり、ユニオン型を構築する `|` インターセクション型を構築する `&` などであり、更に関数型を構築する `=>` や、ジェネリクス型 `Promise<T>` や `Identical<T>` なども相当します。

例えば、単一要素のタプル型 `[T]` の構築子を考えてみましょう。例えばこの構築子は圏内の対象である任意の型 `A` を引数にとって、新しい型 `[A]` を構成します。このとき新しい型 `[A]` は同じ「型と部分型関係の圏」の対象であることはあらかですね。つまり圏内の対象を別の対象にマッピングしています。

関手は対象だけでなく射もマッピングする必要がありますが、この圏における射は部分型関係でした。型と関数の圏(Hask)では射のマッピングなどは自分で定義したりする必要がありますが、部分型関係は部分型付け規則によって定められているので射の対応が自動的に決まります。

配列型の構築子は以下のような部分型付け規則(subtyping rule)を持っているので、二つの型間の部分型関係(つまり対象間の射)は関係を保って移されます。

$$
{S <: T}
\over
{[S] <: [T]}
$$

:::message
上記のようなものは推論規則と呼ばれ、線上に列挙した前提が成立するなら下の結論を導出できる」ということを表現しています。上記の推論規則なら、二つの型 $S, T$ について部分型関係 $S <: T$ が前提として成り立つなら、そのタプル型 $[S], [T]$ についての部分型関係 $[S] <: [T]$ が成り立つということを表現しています。
:::

例えば、数値リテラル型である `1` とその集合的なプリミティブ型 `number` についての部分型関係は `1 <: number` ですが、この二つの型をタプル型の構築子で写して新しい型を構成した場合にの部分型関係は保持されて `[1] <: [number]` となります。

```ts
type Unit = 1;
type Primitive = number;
type C1 = Compat<[Unit], [Primitive]>;
// => Subtype ([Unit] <: [Primitive])
```

さて、部分型関係は考えている圏での射だったわけで、このように射(関係性)の方向を保持する関手は共変関手と呼ばれていました。これがまさに変性の概念であり、型を型構築子によって写して新しい型を構成したときに部分型関係が保持される場合のときに共変(covariant)であると言い、部分型関係が逆転される場合のときに反変(contravariant)と言います。

タプル型に限らずそれぞれの型構築子は独自に変性を持ちます。変性は部分型付け規則によって支配されていますが、多くの場合には共変性を持っています。例えば `Promise<T>` 型構築子も共変であり、以下のような部分型付け規則を持っていると推論されます。

$$
{S <: T}
\over
{Promise \langle S \rangle <: Promise \langle T \rangle}
$$

実際に確かめてみると共変であることが分かります。

```ts
type C2 = Compat<Promise<string>, Promise<string | number>>;
// => Subtype: Promise<string> <: Promise<string | number>
```

## 関数型と双関手

各型構築子は独自に変性を持っていますが、顕著なのが関数型の構築子 `=>` でしょう。これまで見てきた型構築子は型引数が一つのものでしたが、関数型では引数と返り値の型の二つが必要となります。分かりやすくジェネリクスを使って定義すると以下のようになります。

```ts
type F<Fst, Snd> = (param: Fst) => Snd;
```

このように二つの型パラメータを持つ関手は双関手(bifunctor)と呼ばれます。

$$
{P_1 :> P_1 \quad R_1 <: R_2}
\over
{P_1 \rightarrow R_1 <: P_2 \rightarrow R_2}
$$

## 型と関数の圏

副作用などをなくした純粋関数と型の世界を作り、様々な理想的な条件を考えることで TypeScript においても Hask のような型を対象、射を関数の圏を考えることができます。

そのような圏はカルテシアン閉圏(Cartesian closed category)と呼ばれ、直積(タプル型)や冪対象(関数型)といった型の対象について多くの考察(カリー化や随伴など)を考えることができます。

筆者は圏論をそこまで理解していないので、正直手が余ります。そのような圏については Haskell や Scala を中心にして種々の資料がインターネット内外で手に入りますので探してみてください。

このような圏についてのおすすめの文献はimonikikeさんが執筆した『JavaScript徹底攻略 関数』という電子書籍です。JavaScriptでの型と関数の圏について分かりやすく解説しています。

https://booth.pm/ja/items/4435258

